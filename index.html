<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frame Extractor: Select & Extract</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Selection Box */
        .selection-box {
            position: absolute;
            background-color: rgba(59, 130, 246, 0.2); /* Blue tint */
            border: 2px solid #3b82f6; /* Blue border */
            z-index: 20;
            cursor: move;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.1s, border-color 0.1s;
        }
        .selection-box:hover {
            background-color: rgba(59, 130, 246, 0.3);
            border-color: #2563eb;
            z-index: 25;
        }

        /* Active drawing box */
        .selection-box.drawing {
            background-color: rgba(59, 130, 246, 0.1);
            border-style: dashed;
            pointer-events: none;
        }

        /* Delete Handle */
        .box-delete {
            position: absolute;
            top: -10px; right: -10px;
            width: 20px; height: 20px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 30;
            border: 2px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .selection-box:hover .box-delete { display: flex; }
        .box-delete:hover { background-color: #dc2626; transform: scale(1.1); }
        
        /* Placeholder Hover Effect */
        #placeholderText:hover {
            background-color: #f8fafc;
            border-color: #3b82f6;
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 p-4 md:p-6">

    <div class="max-w-[1400px] mx-auto h-[calc(100vh-48px)] flex flex-col">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-4 bg-white p-3 rounded-lg shadow-sm border border-slate-200 shrink-0">
            <h1 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                Frame Extractor <span class="text-slate-400 font-normal text-sm ml-1">Select Mode</span>
            </h1>
            
            <!-- Hidden File Input -->
            <input type="file" id="fileInput" class="hidden" accept="image/*">

            <div id="headerControls" class="hidden">
                 <button id="resetImageBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    New Image
                </button>
            </div>
        </div>

        <div class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0">
            
            <!-- Left Panel: Controls & Editor -->
            <div class="lg:col-span-7 flex flex-col gap-4 min-h-0">
                
                <!-- Info Bar -->
                <div id="controlsPanel" class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 hidden flex justify-between items-center">
                    <div class="text-sm text-slate-600 flex items-center gap-2">
                         <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 font-bold text-xs">1</span>
                         <span>Drag to select areas. Draw multiple boxes to extract multiple items.</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="clearAllBtn" class="text-xs text-red-600 hover:bg-red-50 px-3 py-1.5 rounded font-medium border border-red-200">Clear Selection</button>
                    </div>
                </div>

                <!-- Canvas -->
                <div class="flex-1 bg-slate-100 rounded-xl border border-slate-200 relative overflow-hidden flex items-center justify-center group select-none">
                    
                    <!-- New Placeholder: Clickable Drop Zone -->
                    <div id="placeholderText" class="text-slate-400 text-center p-12 cursor-pointer border-2 border-dashed border-transparent hover:border-blue-400 transition-all rounded-xl w-full h-full flex flex-col items-center justify-center">
                        <svg class="w-16 h-16 text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p class="text-xl font-bold mb-2">Click to Upload Image</p>
                        <p class="text-sm opacity-75">or drag and drop here</p>
                    </div>
                    
                    <div id="previewWrapper" class="relative hidden">
                        <!-- Image Container -->
                        <div id="imageContainer" class="relative shadow-xl bg-white cursor-crosshair">
                            <img id="sourceImg" class="block w-full h-full pointer-events-none select-none">
                            
                            <!-- Selection Layer -->
                            <div id="selectionLayer" class="absolute inset-0 z-20"></div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Panel: Results -->
            <div class="lg:col-span-5 flex flex-col min-h-0 bg-white rounded-xl shadow-sm border border-slate-200">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl shrink-0">
                    <div class="flex items-center gap-3">
                        <h2 class="font-bold text-slate-700">Selected Frames</h2>
                        <span id="countBadge" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                    </div>
                    <button id="downloadAllBtn" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded font-medium transition-colors">
                        Download All
                    </button>
                </div>
                
                <div id="galleryContainer" class="flex-1 overflow-y-auto p-4 bg-white">
                    <div id="gallery" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <div class="col-span-full py-12 text-center text-slate-400 text-sm">
                            Draw a box on the image to see results here
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <canvas id="canvas" class="hidden"></canvas>
    </div>

    <script>
        // --- Elements ---
        const fileInput = document.getElementById('fileInput');
        const headerControls = document.getElementById('headerControls');
        const controlsPanel = document.getElementById('controlsPanel');
        const placeholderText = document.getElementById('placeholderText');
        const previewWrapper = document.getElementById('previewWrapper');
        const imageContainer = document.getElementById('imageContainer');
        const sourceImg = document.getElementById('sourceImg');
        const selectionLayer = document.getElementById('selectionLayer');
        const gallery = document.getElementById('gallery');
        const countBadge = document.getElementById('countBadge');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const resetImageBtn = document.getElementById('resetImageBtn');

        // --- State ---
        let imgObj = null;
        // Selections stored as percentages: [{x, y, w, h}, ...]
        let selections = []; 
        
        let isDrawing = false;
        let drawStart = { x: 0, y: 0 };
        let activeSelectionDiv = null;

        let isMoving = false;
        let moveTargetIndex = -1;
        let moveOffset = { x: 0, y: 0 };

        // --- Init ---
        
        placeholderText.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', e => {
            if(e.target.files[0]) loadFile(e.target.files[0]);
        });
        
        placeholderText.addEventListener('dragover', (e) => {
             e.preventDefault();
             placeholderText.classList.add('bg-blue-50', 'border-blue-400');
        });
        placeholderText.addEventListener('dragleave', () => {
             placeholderText.classList.remove('bg-blue-50', 'border-blue-400');
        });
        placeholderText.addEventListener('drop', (e) => {
            e.preventDefault();
            placeholderText.classList.remove('bg-blue-50', 'border-blue-400');
            if(e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]);
        });

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = e => {
                imgObj = new Image();
                imgObj.onload = () => {
                    initInterface();
                };
                imgObj.src = e.target.result;
                sourceImg.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function initInterface() {
            placeholderText.classList.add('hidden');
            previewWrapper.classList.remove('hidden');
            controlsPanel.classList.remove('hidden');
            headerControls.classList.remove('hidden');
            
            selections = [];
            
            fitImageToCanvas();
            renderSelections();
            extractFrames();
        }

        function resetAll() {
            imgObj = null;
            selections = [];
            sourceImg.src = '';
            fileInput.value = '';

            previewWrapper.classList.add('hidden');
            controlsPanel.classList.add('hidden');
            headerControls.classList.add('hidden');
            placeholderText.classList.remove('hidden');
            gallery.innerHTML = '<div class="col-span-full py-12 text-center text-slate-400 text-sm">Draw a box on the image to see results here</div>';
            countBadge.innerText = '0';
        }

        function fitImageToCanvas() {
            const container = previewWrapper.parentElement;
            const cW = container.clientWidth - 40;
            const cH = container.clientHeight - 40;
            
            const iRatio = imgObj.width / imgObj.height;
            const cRatio = cW / cH;

            let finalW, finalH;
            if (iRatio > cRatio) {
                finalW = cW;
                finalH = cW / iRatio;
            } else {
                finalH = cH;
                finalW = cH * iRatio;
            }

            previewWrapper.style.width = finalW + 'px';
            previewWrapper.style.height = finalH + 'px';
        }

        // --- Interaction Logic ---

        selectionLayer.addEventListener('mousedown', handleMouseDown);
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);

        function handleMouseDown(e) {
            if(e.target.classList.contains('box-delete')) return;

            e.preventDefault();
            const rect = selectionLayer.getBoundingClientRect();
            const clientX = e.clientX - rect.left;
            const clientY = e.clientY - rect.top;

            // Check if clicking inside existing box to move
            // We iterate backwards to catch top-most box first
            const boxIndex = selections.slice().reverse().findIndex(s => {
                const sx = (s.x / 100) * rect.width;
                const sy = (s.y / 100) * rect.height;
                const sw = (s.w / 100) * rect.width;
                const sh = (s.h / 100) * rect.height;
                return clientX >= sx && clientX <= sx + sw && clientY >= sy && clientY <= sy + sh;
            });

            if (boxIndex !== -1) {
                // Moving
                isMoving = true;
                moveTargetIndex = selections.length - 1 - boxIndex; // Convert reverse index to real index
                const sel = selections[moveTargetIndex];
                
                // Calculate offset percent
                moveOffset.x = (clientX / rect.width * 100) - sel.x;
                moveOffset.y = (clientY / rect.height * 100) - sel.y;
                return;
            }

            // Drawing new box
            isDrawing = true;
            drawStart = { x: clientX, y: clientY };
            
            // Create temp visual div
            activeSelectionDiv = document.createElement('div');
            activeSelectionDiv.className = 'selection-box drawing';
            activeSelectionDiv.style.left = clientX + 'px';
            activeSelectionDiv.style.top = clientY + 'px';
            activeSelectionDiv.style.width = '0px';
            activeSelectionDiv.style.height = '0px';
            selectionLayer.appendChild(activeSelectionDiv);
        }

        function handleMouseMove(e) {
            const rect = selectionLayer.getBoundingClientRect();
            const clientX = e.clientX - rect.left;
            const clientY = e.clientY - rect.top;

            if (isMoving && moveTargetIndex !== -1) {
                let newX = (clientX / rect.width * 100) - moveOffset.x;
                let newY = (clientY / rect.height * 100) - moveOffset.y;
                
                const sel = selections[moveTargetIndex];
                
                // Clamp to bounds
                newX = Math.max(0, Math.min(100 - sel.w, newX));
                newY = Math.max(0, Math.min(100 - sel.h, newY));
                
                selections[moveTargetIndex].x = newX;
                selections[moveTargetIndex].y = newY;
                
                renderSelections();
            }
            else if (isDrawing && activeSelectionDiv) {
                const left = Math.min(drawStart.x, clientX);
                const top = Math.min(drawStart.y, clientY);
                const width = Math.abs(clientX - drawStart.x);
                const height = Math.abs(clientY - drawStart.y);

                activeSelectionDiv.style.left = left + 'px';
                activeSelectionDiv.style.top = top + 'px';
                activeSelectionDiv.style.width = width + 'px';
                activeSelectionDiv.style.height = height + 'px';
            }
        }

        function handleMouseUp(e) {
            const rect = selectionLayer.getBoundingClientRect();

            if (isMoving) {
                isMoving = false;
                moveTargetIndex = -1;
                extractFrames(); // Update gallery after move
            }
            else if (isDrawing && activeSelectionDiv) {
                isDrawing = false;
                
                // Parse final geometry
                const style = getComputedStyle(activeSelectionDiv);
                const pxLeft = parseFloat(style.left);
                const pxTop = parseFloat(style.top);
                const pxWidth = parseFloat(style.width);
                const pxHeight = parseFloat(style.height);
                
                // Remove temp div
                activeSelectionDiv.remove();
                activeSelectionDiv = null;

                // Threshold to ignore clicks
                if (pxWidth < 10 || pxHeight < 10) return;

                // Convert to percentages
                const pctX = (pxLeft / rect.width) * 100;
                const pctY = (pxTop / rect.height) * 100;
                const pctW = (pxWidth / rect.width) * 100;
                const pctH = (pxHeight / rect.height) * 100;

                selections.push({ x: pctX, y: pctY, w: pctW, h: pctH });
                renderSelections();
                extractFrames();
            }
        }

        // --- Rendering ---

        function renderSelections() {
            selectionLayer.innerHTML = '';
            
            selections.forEach((sel, index) => {
                const el = document.createElement('div');
                el.className = 'selection-box';
                el.style.left = sel.x + '%';
                el.style.top = sel.y + '%';
                el.style.width = sel.w + '%';
                el.style.height = sel.h + '%';
                
                const del = document.createElement('div');
                del.className = 'box-delete';
                del.innerText = 'Ã—';
                del.title = 'Remove selection';
                del.onmousedown = (e) => {
                    e.stopPropagation(); // Prevent drag start
                    selections.splice(index, 1);
                    renderSelections();
                    extractFrames();
                };
                el.appendChild(del);
                
                selectionLayer.appendChild(el);
            });
        }

        // --- Extraction ---

        function extractFrames() {
            if(!imgObj) return;

            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            gallery.innerHTML = '';
            
            if (selections.length === 0) {
                 gallery.innerHTML = '<div class="col-span-full py-12 text-center text-slate-400 text-sm">Draw a box on the image to see results here</div>';
                 countBadge.innerText = '0';
                 return;
            }

            let count = 0;

            selections.forEach((sel, i) => {
                // High Quality Extraction: Use original image dimensions
                const x = (sel.x / 100) * imgObj.width;
                const y = (sel.y / 100) * imgObj.height;
                const w = (sel.w / 100) * imgObj.width;
                const h = (sel.h / 100) * imgObj.height;

                if(w < 1 || h < 1) return; 

                canvas.width = w;
                canvas.height = h;
                
                // Clear canvas just in case (though we resize it)
                ctx.clearRect(0,0,w,h);
                
                // Draw full resolution pixels
                ctx.drawImage(imgObj, x, y, w, h, 0, 0, w, h);
                
                addGalleryItem(canvas.toDataURL('image/png'), ++count);
            });
            
            countBadge.innerText = count;
        }

        function addGalleryItem(src, idx) {
            const div = document.createElement('div');
            div.className = 'group relative aspect-square bg-slate-50 border border-slate-200 rounded-lg overflow-hidden flex items-center justify-center hover:shadow-md transition-all';
            div.innerHTML = `
                <img src="${src}" class="max-w-full max-h-full object-contain p-1">
                <div class="absolute top-1 left-1 bg-black/50 text-white text-[10px] px-1.5 rounded font-medium">#${idx}</div>
                <a href="${src}" download="frame_${idx}.png" class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                    <span class="bg-white text-slate-900 px-3 py-1 rounded shadow-sm text-xs font-bold transform translate-y-2 group-hover:translate-y-0 transition-transform">Download</span>
                </a>
            `;
            gallery.appendChild(div);
        }

        // --- Controls ---
        clearAllBtn.addEventListener('click', () => {
            selections = [];
            renderSelections();
            extractFrames();
        });
        
        resetImageBtn.addEventListener('click', resetAll);

        downloadAllBtn.addEventListener('click', () => {
            const links = gallery.querySelectorAll('a');
            if(links.length === 0) return alert('No selections to download');
            let i = 0;
            const next = () => {
                if(i >= links.length) return;
                links[i].click();
                i++;
                setTimeout(next, 150);
            };
            next();
        });

        window.addEventListener('resize', () => {
            if(imgObj) fitImageToCanvas();
        });

    </script>
</body>
</html>
